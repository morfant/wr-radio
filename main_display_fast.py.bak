#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import RPi.GPIO as GPIO
import time
import json
import os
import subprocess
import socket
import sys
import spidev
import requests
import threading
from PIL import Image, ImageDraw, ImageFont

# ===============================
# GPIO í•€ ë²ˆí˜¸ ì„¤ì • (BCM)
# ===============================
S1 = 17   # ë¡œí„°ë¦¬ CLK
S2 = 27   # ë¡œí„°ë¦¬ DT
KEY = 22  # ë¡œí„°ë¦¬ ë²„íŠ¼

CS_PIN = 26   # LCD
DC_PIN = 19
RST_PIN = 13
BL_PIN = 6

# ===============================
# ì„¤ì • íŒŒì¼
# ===============================
CONFIG_FILE = "/home/wr-radio/wr-radio/config.json"
LOCK_FILE = "/tmp/wr_radio.lock"

# ê¸°ë³¸ ìŠ¤í…Œì´ì…˜ ëª©ë¡
DEFAULT_STATIONS = [
    {
        "name": "Jeju Georo",
        "url": "https://locus.creacast.com:9443/jeju_georo.mp3",
        "location": "Jeju, South Korea",
        "lat": 33.509306,
        "lon": 126.562000,
        "color": [100, 200, 255]
    },
    {
        "name": "London Stave Hill",
        "url": "https://locus.creacast.com:9443/london_stave_hill.mp3",
        "location": "London, UK",
        "lat": 51.502111,
        "lon": -0.040278,
        "color": [255, 100, 100]
    },
    {
        "name": "New York Wave Farm",
        "url": "https://locus.creacast.com:9443/acra_wave_farm.mp3",
        "location": "Acra, New York",
        "lat": 42.319111,
        "lon": -74.076611,
        "color": [255, 200, 50]
    },
    {
        "name": "Jasper Ridge",
        "url": "https://locus.creacast.com:9443/jasper_ridge_birdcast.mp3",
        "location": "California, USA",
        "lat": 37.403611,
        "lon": -122.238000,
        "color": [100, 255, 100]
    },
    {
        "name": "Mt. Fuji Forest",
        "url": "http://mp3s.nc.u-tokyo.ac.jp/Fuji_CyberForest.mp3",
        "location": "Yamanashi, Japan",
        "lat": 35.4088,
        "lon": 138.86,
        "color": [200, 100, 255]
    }
]

# ===============================
# ì „ì—­ ë³€ìˆ˜
# ===============================
weather_cache = {}
WEATHER_CACHE_TIME = 600  # 10ë¶„
weather_lock = threading.Lock()

OPENWEATHER_API_KEY = ""
ENABLE_WEATHER = False
radio_stations = []

spi = None
pwm_backlight = None
player_process = None
is_playing = False

# ë””ìŠ¤í”Œë ˆì´ ìºì‹œ
last_displayed_index = -1
last_displayed_playing = None
pending_display_update = False
display_target_index = 0

MPV_SOCK = "/tmp/wr_mpv.sock"
ROTATION_DEBOUNCE_SEC = 0.02  # ì…ë ¥ ê°ì§€
PLAY_SWITCH_DELAY_SEC = 0.40  # ì˜¤ë””ì˜¤ ì „í™˜
DISPLAY_UPDATE_DELAY = 0.08  # ì…ë ¥ ë©ˆì¶˜ í›„ í™”ë©´ ì—…ë°ì´íŠ¸
SAVE_DELAY_SEC = 1.0

# ===============================
# ì„¤ì • ê´€ë¦¬
# ===============================
def load_config():
    """ì„¤ì • íŒŒì¼ ë¡œë“œ"""
    if os.path.exists(CONFIG_FILE):
        try:
            with open(CONFIG_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        except Exception as e:
            print(f"âš ï¸  ì„¤ì • íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: {e}")
    return None

def save_config(config):
    """ì„¤ì • íŒŒì¼ ì €ì¥"""
    try:
        os.makedirs(os.path.dirname(CONFIG_FILE), exist_ok=True)
        with open(CONFIG_FILE, 'w', encoding='utf-8') as f:
            json.dump(config, f, indent=2, ensure_ascii=False)
        return True
    except Exception as e:
        print(f"âŒ ì„¤ì • ì €ì¥ ì‹¤íŒ¨: {e}")
        return False

def create_default_config():
    """ê¸°ë³¸ ì„¤ì • íŒŒì¼ ìƒì„±"""
    config = {
        "openweather_api_key": "",
        "last_station": 0,
        "stations": DEFAULT_STATIONS
    }
    
    if save_config(config):
        print("âœ… ê¸°ë³¸ config.json ìƒì„± ì™„ë£Œ")
        return config
    return None

def setup_config():
    """ì„¤ì • ì´ˆê¸°í™” ë˜ëŠ” ë¡œë“œ"""
    config = load_config()
    
    if config is None:
        print("\n" + "="*60)
        print("ğŸ“» WR-Radio ì²« ì‹¤í–‰ ì„¤ì •")
        print("="*60)
        print()
        print("config.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ì„¤ì •ì„ ìƒì„±í•©ë‹ˆë‹¤.")
        print()
        
        config = create_default_config()
        if config is None:
            print("âŒ ì„¤ì • íŒŒì¼ ìƒì„± ì‹¤íŒ¨")
            return None
        
        print()
        print("ğŸŒ¤ï¸  OpenWeatherMap API í‚¤ ì„¤ì • (ì„ íƒì‚¬í•­)")
        print("-" * 60)
        print("ë¬´ë£Œ API í‚¤ ë°œê¸‰: https://openweathermap.org/appid")
        print("(ì—”í„°ë§Œ ëˆ„ë¥´ë©´ ë‚ ì”¨ ê¸°ëŠ¥ ë¹„í™œì„±í™”)")
        print()
        
        api_key = input("API í‚¤ ì…ë ¥: ").strip()
        
        if api_key:
            config['openweather_api_key'] = api_key
            save_config(config)
            print("âœ… API í‚¤ ì €ì¥ ì™„ë£Œ!")
        else:
            print("âš ï¸  ë‚ ì”¨ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")
        
        print()
        print("="*60)
        print("ğŸ’¡ ìŠ¤í…Œì´ì…˜ ëª©ë¡ ìˆ˜ì •: nano ~/wr-radio/wr-radio/config.json")
        print("="*60)
        print()
    
    # ê²€ì¦
    if 'stations' not in config or not config['stations']:
        print("âš ï¸  ìŠ¤í…Œì´ì…˜ ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ê¸°ë³¸ ëª©ë¡ ì‚¬ìš©")
        config['stations'] = DEFAULT_STATIONS
    
    # colorë¥¼ tupleë¡œ ë³€í™˜
    for station in config['stations']:
        if isinstance(station.get('color'), list):
            station['color'] = tuple(station['color'])
        elif 'color' not in station:
            station['color'] = (100, 200, 255)
    
    return config

def save_last_station(index):
    """ë§ˆì§€ë§‰ ìŠ¤í…Œì´ì…˜ ì €ì¥"""
    try:
        config = load_config()
        if config:
            config['last_station'] = index
            save_config(config)
            print("ğŸ’¾ ì €ì¥ ì™„ë£Œ")
    except Exception as e:
        print(f"ì €ì¥ ì‹¤íŒ¨: {e}")

def acquire_lock():
    """í”„ë¡œì„¸ìŠ¤ ì ê¸ˆ"""
    if os.path.exists(LOCK_FILE):
        try:
            with open(LOCK_FILE, "r") as f:
                pid = int((f.read() or "0").strip())
            if pid > 0:
                os.kill(pid, 0)
                print(f"âŒ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤ (pid={pid}).")
                sys.exit(1)
        except ProcessLookupError:
            pass
        except Exception:
            pass

    with open(LOCK_FILE, "w") as f:
        f.write(str(os.getpid()))

def release_lock():
    """í”„ë¡œì„¸ìŠ¤ ì ê¸ˆ í•´ì œ"""
    try:
        if os.path.exists(LOCK_FILE):
            os.remove(LOCK_FILE)
    except Exception:
        pass

def draw_weather_icon(draw, x, y, icon_code):
    """ë‚ ì”¨ ì•„ì´ì½˜ì„ PIL ë„í˜•ìœ¼ë¡œ ê·¸ë¦¬ê¸° (ë¹ ë¦„!)"""
    if icon_code == '01':  # ë§‘ìŒ - í–‡
        # ì›
        draw.ellipse([x, y, x+14, y+14], fill=(255, 200, 0))
        # ê´‘ì„  (8ë°©í–¥)
        cx, cy = x+7, y+7
        rays = [
            (cx, y-3, cx, y),           # ìœ„
            (cx, y+14, cx, y+17),       # ì•„ë˜
            (x-3, cy, x, cy),           # ì™¼ìª½
            (x+14, cy, x+17, cy),       # ì˜¤ë¥¸ìª½
            (x-2, y-2, x+1, y+1),       # ì™¼ìœ„
            (x+13, y-2, x+16, y+1),     # ì˜¤ë¥¸ìœ„
            (x-2, y+13, x+1, y+16),     # ì™¼ì•„ë˜
            (x+13, y+13, x+16, y+16)    # ì˜¤ë¥¸ì•„ë˜
        ]
        for ray in rays:
            draw.line(ray, fill=(255, 200, 0), width=1)
    
    elif icon_code == '02':  # ì•½ê°„ íë¦¼ - í–‡+êµ¬ë¦„
        # ì‘ì€ í–‡
        draw.ellipse([x, y, x+10, y+10], fill=(255, 200, 0))
        # êµ¬ë¦„
        draw.ellipse([x+8, y+6, x+20, y+16], fill=(180, 180, 180))
        draw.ellipse([x+12, y+4, x+24, y+14], fill=(200, 200, 200))
    
    elif icon_code in ['03', '04']:  # íë¦¼ - êµ¬ë¦„
        # ì—¬ëŸ¬ ì›ìœ¼ë¡œ êµ¬ë¦„ í‘œí˜„
        draw.ellipse([x, y+4, x+12, y+14], fill=(160, 160, 160))
        draw.ellipse([x+6, y, x+18, y+10], fill=(180, 180, 180))
        draw.ellipse([x+10, y+4, x+22, y+14], fill=(200, 200, 200))
    
    elif icon_code in ['09', '10']:  # ë¹„
        # êµ¬ë¦„
        draw.ellipse([x, y, x+12, y+8], fill=(120, 120, 120))
        draw.ellipse([x+6, y-2, x+18, y+6], fill=(140, 140, 140))
        # ë¹—ì¤„ê¸°
        for i in range(4):
            x_pos = x + 2 + i * 4
            draw.line([x_pos, y+10, x_pos-2, y+16], fill=(100, 150, 255), width=1)
    
    elif icon_code == '11':  # ì²œë‘¥
        # êµ¬ë¦„
        draw.ellipse([x, y, x+12, y+8], fill=(80, 80, 80))
        draw.ellipse([x+6, y-2, x+18, y+6], fill=(100, 100, 100))
        # ë²ˆê°œ
        draw.line([x+10, y+8, x+8, y+12], fill=(255, 255, 0), width=2)
        draw.line([x+8, y+12, x+10, y+16], fill=(255, 255, 0), width=2)
    
    elif icon_code == '13':  # ëˆˆ
        # êµ¬ë¦„
        draw.ellipse([x, y, x+12, y+8], fill=(180, 180, 180))
        draw.ellipse([x+6, y-2, x+18, y+6], fill=(200, 200, 200))
        # ëˆˆì†¡ì´ (ì‘ì€ ì‹­ì)
        for i in range(3):
            x_pos = x + 4 + i * 4
            y_pos = y + 11 + i * 2
            draw.line([x_pos-2, y_pos, x_pos+2, y_pos], fill=(255, 255, 255), width=1)
            draw.line([x_pos, y_pos-2, x_pos, y_pos+2], fill=(255, 255, 255), width=1)
    
    elif icon_code == '50':  # ì•ˆê°œ
        # ìˆ˜í‰ì„ ë“¤
        for i in range(5):
            y_pos = y + i * 3
            draw.line([x, y_pos, x+18, y_pos], fill=(150, 150, 150), width=1)

# ===============================
# ë‚ ì”¨ ì •ë³´
# ===============================
def fetch_weather_background(lat, lon, location_name):
    """ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë‚ ì”¨ ê°€ì ¸ì˜¤ê¸°"""
    if not ENABLE_WEATHER:
        return
    
    cache_key = f"{lat},{lon}"
    
    try:
        url = f"http://api.openweathermap.org/data/2.5/weather"
        params = {
            'lat': lat,
            'lon': lon,
            'appid': OPENWEATHER_API_KEY,
            'units': 'metric',
            'lang': 'kr'
        }
        
        response = requests.get(url, params=params, timeout=5)
        
        if response.status_code == 200:
            data = response.json()
            temp = int(data['main']['temp'])
            icon_code = data['weather'][0]['icon'][:2]
            
            # ì•„ì´ì½˜ ì½”ë“œì™€ ì˜¨ë„ë¥¼ ë”•ì…”ë„ˆë¦¬ë¡œ ì €ì¥
            weather_data = {
                'icon': icon_code,
                'temp': temp
            }
            
            with weather_lock:
                weather_cache[cache_key] = (time.time(), weather_data)
            print(f"ğŸŒ¤ï¸  ë‚ ì”¨ ì—…ë°ì´íŠ¸: {location_name} - {temp}Â°C")
        else:
            print(f"âš ï¸  ë‚ ì”¨ HTTP {response.status_code}: {location_name}")
            
    except Exception as e:
        print(f"âš ï¸  ë‚ ì”¨ ì‹¤íŒ¨: {location_name} - {str(e)[:50]}")

def get_cached_weather(lat, lon):
    """ìºì‹œëœ ë‚ ì”¨ ê°€ì ¸ì˜¤ê¸°"""
    if not ENABLE_WEATHER:
        return None
    
    cache_key = f"{lat},{lon}"
    with weather_lock:
        if cache_key in weather_cache:
            cached_time, cached_data = weather_cache[cache_key]
            return cached_data  # {'icon': '01', 'temp': 15}
    return None

def should_update_weather(lat, lon):
    """ë‚ ì”¨ ì—…ë°ì´íŠ¸ í•„ìš” ì—¬ë¶€"""
    if not ENABLE_WEATHER:
        return False
    
    cache_key = f"{lat},{lon}"
    with weather_lock:
        if cache_key not in weather_cache:
            return True
        cached_time, _ = weather_cache[cache_key]
        return (time.time() - cached_time) >= WEATHER_CACHE_TIME

def start_weather_update(station_index):
    """ë°±ê·¸ë¼ìš´ë“œ ë‚ ì”¨ ì—…ë°ì´íŠ¸ - í•„ìš”í•  ë•Œë§Œ"""
    if not ENABLE_WEATHER:
        return
    
    station = radio_stations[station_index]
    if should_update_weather(station["lat"], station["lon"]):
        thread = threading.Thread(
            target=fetch_weather_background,
            args=(station["lat"], station["lon"], station["location"]),
            daemon=True
        )
        thread.start()

# ===============================
# ë°±ë¼ì´íŠ¸ ì œì–´
# ===============================
def backlight_on():
    global pwm_backlight
    if pwm_backlight:
        pwm_backlight.stop()
        pwm_backlight = None
    GPIO.output(BL_PIN, GPIO.HIGH)

def backlight_off():
    global pwm_backlight
    if pwm_backlight:
        pwm_backlight.stop()
        pwm_backlight = None
    GPIO.output(BL_PIN, GPIO.LOW)

def set_brightness(level):
    global pwm_backlight
    if pwm_backlight:
        pwm_backlight.ChangeDutyCycle(level)
    else:
        pwm_backlight = GPIO.PWM(BL_PIN, 1000)
        pwm_backlight.start(level)

# ===============================
# LCD ì €ìˆ˜ì¤€ ì œì–´
# ===============================
def reset():
    GPIO.output(RST_PIN, GPIO.HIGH)
    time.sleep(0.01)
    GPIO.output(RST_PIN, GPIO.LOW)
    time.sleep(0.01)
    GPIO.output(RST_PIN, GPIO.HIGH)
    time.sleep(0.12)

def write_cmd(cmd):
    GPIO.output(DC_PIN, GPIO.LOW)
    GPIO.output(CS_PIN, GPIO.LOW)
    spi.writebytes([cmd])
    GPIO.output(CS_PIN, GPIO.HIGH)

def write_data(data):
    GPIO.output(DC_PIN, GPIO.HIGH)
    GPIO.output(CS_PIN, GPIO.LOW)
    if isinstance(data, list):
        spi.writebytes(data)
    else:
        spi.writebytes([data])
    GPIO.output(CS_PIN, GPIO.HIGH)

def set_rotation(rotation):
    write_cmd(0x36)
    if rotation == 0:
        write_data(0x00)
    elif rotation == 90:
        write_data(0x60)
    elif rotation == 180:
        write_data(0xC0)
    elif rotation == 270:
        write_data(0xA0)
    else:
        write_data(0x00)

def init_display(rotation=90):
    reset()
    write_cmd(0x01)
    time.sleep(0.15)
    write_cmd(0x11)
    time.sleep(0.12)
    write_cmd(0x3A)
    write_data(0x05)
    set_rotation(rotation)
    write_cmd(0x21)
    write_cmd(0x13)
    write_cmd(0x29)
    time.sleep(0.01)

# ===============================
# ê·¸ë˜í”½ í•¨ìˆ˜
# ===============================
def rgb565(r, g, b):
    return ((r & 0xF8) << 8) | ((g & 0xFC) << 3) | (b >> 3)

def set_window(x0, y0, x1, y1):
    write_cmd(0x2A)
    write_data([x0 >> 8, x0 & 0xFF, x1 >> 8, x1 & 0xFF])
    write_cmd(0x2B)
    write_data([y0 >> 8, y0 & 0xFF, y1 >> 8, y1 & 0xFF])
    write_cmd(0x2C)

def display_image(image):
    """ì „ì²´ í™”ë©´ ì—…ë°ì´íŠ¸"""
    if image.size != (240, 240):
        image = image.resize((240, 240))
    
    image = image.convert('RGB')
    set_window(0, 0, 239, 239)
    
    pixels = []
    for y in range(240):
        for x in range(240):
            r, g, b = image.getpixel((x, y))
            color = rgb565(r, g, b)
            pixels.append((color >> 8) & 0xFF)
            pixels.append(color & 0xFF)
    
    GPIO.output(DC_PIN, GPIO.HIGH)
    GPIO.output(CS_PIN, GPIO.LOW)
    
    chunk_size = 4096
    for i in range(0, len(pixels), chunk_size):
        spi.writebytes(pixels[i:i+chunk_size])
    
    GPIO.output(CS_PIN, GPIO.HIGH)

def display_image_region(image, x0, y0, x1, y1):
    """í™”ë©´ íŠ¹ì • ì˜ì—­ë§Œ ì—…ë°ì´íŠ¸ (ë¶€ë¶„ ë Œë”ë§)"""
    if image.size != (240, 240):
        image = image.resize((240, 240))
    
    image = image.convert('RGB')
    set_window(x0, y0, x1, y1)
    
    pixels = []
    for y in range(y0, y1 + 1):
        for x in range(x0, x1 + 1):
            r, g, b = image.getpixel((x, y))
            color = rgb565(r, g, b)
            pixels.append((color >> 8) & 0xFF)
            pixels.append(color & 0xFF)
    
    GPIO.output(DC_PIN, GPIO.HIGH)
    GPIO.output(CS_PIN, GPIO.LOW)
    
    chunk_size = 4096
    for i in range(0, len(pixels), chunk_size):
        spi.writebytes(pixels[i:i+chunk_size])
    
    GPIO.output(CS_PIN, GPIO.HIGH)

# ===============================
# UI í‘œì‹œ (ìµœì í™” ë²„ì „)
# ===============================
def display_radio_info(current_index, force_full=False):
    """ë¼ë””ì˜¤ ì •ë³´ í‘œì‹œ - ë¶€ë¶„ ì—…ë°ì´íŠ¸ ìµœì í™”"""
    global last_displayed_index, last_displayed_playing
    
    station = radio_stations[current_index]
    station_changed = (current_index != last_displayed_index)
    playing_changed = (is_playing != last_displayed_playing)
    
    # ìŠ¤í…Œì´ì…˜ì´ ë°”ë€Œì—ˆì„ ë•Œë§Œ ë‚ ì”¨ í™•ì¸
    if station_changed and should_update_weather(station["lat"], station["lon"]):
        start_weather_update(current_index)
    
    weather = get_cached_weather(station["lat"], station["lon"])
    
    # ì „ì²´ ì´ë¯¸ì§€ ìƒì„±
    image = Image.new('RGB', (240, 240), (0, 0, 0))
    draw = ImageDraw.Draw(image)
    
    try:
        font_large = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf", 28)
        font_medium = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", 20)
        font_small = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", 16)
        font_tiny = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", 14)
        
        # ì´ëª¨ì§€ í°íŠ¸ ì‹œë„
        try:
            font_emoji = ImageFont.truetype("/usr/share/fonts/truetype/noto/NotoEmoji-Regular.ttf", 16)
            has_emoji = True
        except:
            try:
                font_emoji = ImageFont.truetype("/usr/share/fonts/truetype/noto/NotoColorEmoji.ttf", 16)
                has_emoji = True
            except:
                has_emoji = False
    except:
        font_large = ImageFont.load_default()
        font_medium = ImageFont.load_default()
        font_small = ImageFont.load_default()
        font_tiny = ImageFont.load_default()
        has_emoji = False
    
    # ìŠ¤í…Œì´ì…˜ì´ ë°”ë€ ê²½ìš°: ìƒë‹¨ ì˜ì—­ ì—…ë°ì´íŠ¸
    if force_full or station_changed:
        # ìŠ¤í…Œì´ì…˜ ì´ë¦„ (í•œ ì¤„ë¡œ í‘œì‹œ, ê¸¸ì´ì— ë”°ë¼ í°íŠ¸ ì¡°ì •)
        station_name = station["name"]
        
        # í°íŠ¸ í¬ê¸° ê²°ì • (16ptë¶€í„° ì‹œì‘, í•„ìš”ì‹œ ë” ì‘ê²Œ)
        bbox = draw.textbbox((0, 0), station_name, font=font_small)  # 16pt ì‹œë„
        text_width = bbox[2] - bbox[0]
        
        if text_width > 230:  # ê¸¸ë©´ 14pt ì‹œë„
            bbox = draw.textbbox((0, 0), station_name, font=font_tiny)
            text_width = bbox[2] - bbox[0]
            if text_width > 230:  # ì—¬ì „íˆ ê¸¸ë©´ 12pt
                try:
                    font_mini = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", 12)
                except:
                    font_mini = ImageFont.load_default()
                bbox = draw.textbbox((0, 0), station_name, font=font_mini)
                text_width = bbox[2] - bbox[0]
                x = max(5, (240 - text_width) // 2)
                draw.text((x, 32), station_name, font=font_mini, fill=(220, 220, 220))
                location_y = 50
            else:  # 14pt
                x = max(5, (240 - text_width) // 2)
                draw.text((x, 30), station_name, font=font_tiny, fill=(220, 220, 220))
                location_y = 50
        else:  # 16pt
            x = (240 - text_width) // 2
            draw.text((x, 28), station_name, font=font_small, fill=(220, 220, 220))
            location_y = 50
        
        # ìœ„ì¹˜ ì •ë³´
        bbox = draw.textbbox((0, 0), station["location"], font=font_tiny)
        text_width = bbox[2] - bbox[0]
        x = (240 - text_width) // 2
        draw.text((x, location_y + 5), station["location"], font=font_tiny, fill=(120, 120, 120))
        
        # ë‚ ì”¨ ì •ë³´
        if weather:
            # ì•„ì´ì½˜ ê·¸ë¦¬ê¸° (ì™¼ìª½)
            icon_x = 90
            icon_y = location_y + 25
            draw_weather_icon(draw, icon_x, icon_y, weather['icon'])
            
            # ì˜¨ë„ í…ìŠ¤íŠ¸ (ì˜¤ë¥¸ìª½)
            temp_text = f"{weather['temp']}Â°C"
            draw.text((icon_x + 28, location_y + 27), temp_text, font=font_small, fill=(100, 200, 255))
        
        # ìƒë‹¨ ì˜ì—­ë§Œ ì—…ë°ì´íŠ¸ (0-110ì¤„ë¡œ ì¶•ì†Œ)
        display_image_region(image, 0, 0, 239, 110)
        
        # í•˜ë‹¨ ìŠ¤í…Œì´ì…˜ ë²ˆí˜¸ ì˜ì—­
        station_num = f"{current_index + 1} / {len(radio_stations)}"
        bbox = draw.textbbox((0, 0), station_num, font=font_medium)
        text_width = bbox[2] - bbox[0]
        x = (240 - text_width) // 2
        draw.text((x, 200), station_num, font=font_medium, fill=(120, 120, 120))
        
        # í•˜ë‹¨ ì˜ì—­ë§Œ ì—…ë°ì´íŠ¸ (195-239ì¤„ë¡œ ì¶•ì†Œ)
        display_image_region(image, 0, 195, 239, 239)
        
        last_displayed_index = current_index
    
    # ì¬ìƒ ìƒíƒœ ì˜ì—­ì€ í•­ìƒ ì—…ë°ì´íŠ¸ (ì¤‘ì•™)
    if force_full or station_changed or playing_changed:
        status_y = 130
        
        # ì¬ìƒ ìƒíƒœ
        status = "â–¶ PLAYING" if is_playing else "â¸ PAUSED"
        status_color = (100, 255, 100) if is_playing else (200, 200, 200)
        bbox = draw.textbbox((0, 0), status, font=font_medium)
        text_width = bbox[2] - bbox[0]
        x = (240 - text_width) // 2
        draw.text((x, status_y), status, font=font_medium, fill=status_color)
        
        # ìŒíŒŒ ì• ë‹ˆë©”ì´ì…˜ (ìƒ‰ìƒ ëŒ€ì‹  í°ìƒ‰/íšŒìƒ‰)
        if is_playing:
            center_y = status_y + 35
            for i in range(5):
                height = 8 + (i % 3) * 6
                x_pos = 65 + i * 22
                draw.rectangle([x_pos, center_y - height, x_pos + 12, center_y + height], 
                             fill=(80, 80, 80))
        
        # ì¤‘ì•™ ì˜ì—­ë§Œ ì—…ë°ì´íŠ¸ (125-185ì¤„ë¡œ ì¶•ì†Œ)
        display_image_region(image, 0, 125, 239, 185)
        
        last_displayed_playing = is_playing

# ===============================
# mpv IPC ìœ í‹¸
# ===============================
def _can_connect_mpv(sock_path=MPV_SOCK, timeout=0.2):
    if not os.path.exists(sock_path):
        return False
    try:
        s = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
        s.settimeout(timeout)
        s.connect(sock_path)
        s.close()
        return True
    except Exception:
        return False

def _wait_for_mpv_sock(timeout_sec=8.0):
    start = time.time()
    while time.time() - start < timeout_sec:
        if _can_connect_mpv(MPV_SOCK, timeout=0.2):
            return True
        time.sleep(0.05)
    return False

def mpv_cmd(payload):
    try:
        s = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
        s.settimeout(0.5)
        s.connect(MPV_SOCK)
        s.send((json.dumps(payload) + "\n").encode("utf-8"))
        s.close()
        return True
    except Exception:
        return False

def ensure_mpv_running():
    global player_process

    if _can_connect_mpv(MPV_SOCK):
        return True

    try:
        if os.path.exists(MPV_SOCK):
            os.remove(MPV_SOCK)
    except Exception:
        pass

    cmd = [
        "mpv",
        "--no-video",
        "--idle=yes",
        "--no-terminal",
        "--no-config",
        "--load-scripts=no",
        "--osc=no",
        "--input-default-bindings=no",
        "--input-ipc-server=" + MPV_SOCK,
        "--volume=50",
        "--cache=yes",
        "--cache-secs=0.3",
        "--demuxer-readahead-secs=0.3",
        "--network-timeout=3",
    ]

    try:
        player_process = subprocess.Popen(
            cmd,
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL
        )
    except Exception as e:
        print(f"âŒ mpv ì‹¤í–‰ ì‹¤íŒ¨: {e}")
        player_process = None
        return False

    ok = _wait_for_mpv_sock(timeout_sec=8.0)
    if not ok:
        print("âŒ mpv IPC ì†Œì¼“ ìƒì„± ì‹¤íŒ¨")
        return False

    return True

def stop_playback():
    global is_playing
    if mpv_cmd({"command": ["stop"]}):
        is_playing = False
        print("â¹ï¸  ì¬ìƒ ì¤‘ì§€")
    else:
        print("âš ï¸  stop ì‹¤íŒ¨")

def play_station(index):
    global is_playing
    station = radio_stations[index]
    print(f"\nğŸµ ì¬ìƒ: {station['name']}")
    
    ok = mpv_cmd({"command": ["loadfile", station["url"], "replace"]})
    if ok:
        is_playing = True
    else:
        print("âŒ ì¬ìƒ ì‹¤íŒ¨")
        is_playing = False
    
    display_radio_info(index)

# ===============================
# ë©”ì¸
# ===============================
def main():
    global is_playing, OPENWEATHER_API_KEY, ENABLE_WEATHER, radio_stations, spi
    global pending_display_update, display_target_index
    
    # ì„¤ì • ë¡œë“œ
    config = setup_config()
    if config is None:
        print("âŒ ì„¤ì • ì´ˆê¸°í™” ì‹¤íŒ¨")
        return
    
    # ì „ì—­ ë³€ìˆ˜ ì„¤ì •
    OPENWEATHER_API_KEY = config.get('openweather_api_key', '')
    ENABLE_WEATHER = bool(OPENWEATHER_API_KEY)
    radio_stations = config['stations']
    current_index = config.get('last_station', 0)
    
    if not (0 <= current_index < len(radio_stations)):
        current_index = 0
    
    if ENABLE_WEATHER:
        print(f"ğŸŒ¤ï¸  ë‚ ì”¨ ê¸°ëŠ¥ í™œì„±í™”")
    else:
        print(f"âš ï¸  ë‚ ì”¨ ê¸°ëŠ¥ ë¹„í™œì„±í™” (API í‚¤ ì—†ìŒ)")
    
    print(f"ğŸ“» ìŠ¤í…Œì´ì…˜ {len(radio_stations)}ê°œ ë¡œë“œ")
    
    acquire_lock()
    
    # SPI ì´ˆê¸°í™” - ì†ë„ í–¥ìƒ!
    spi = spidev.SpiDev()
    spi.open(0, 0)
    spi.max_speed_hz = 64000000  # 8MHz â†’ 64MHz
    spi.mode = 0
    
    # GPIO ì´ˆê¸°í™”
    GPIO.setwarnings(False)
    GPIO.setmode(GPIO.BCM)
    
    GPIO.setup(S1, GPIO.IN, pull_up_down=GPIO.PUD_UP)
    GPIO.setup(S2, GPIO.IN, pull_up_down=GPIO.PUD_UP)
    GPIO.setup(KEY, GPIO.IN, pull_up_down=GPIO.PUD_UP)
    
    GPIO.setup(CS_PIN, GPIO.OUT)
    GPIO.setup(DC_PIN, GPIO.OUT)
    GPIO.setup(RST_PIN, GPIO.OUT)
    GPIO.setup(BL_PIN, GPIO.OUT)
    
    # LCD ì´ˆê¸°í™”
    print("LCD ì´ˆê¸°í™” ì¤‘...")
    init_display(rotation=90)
    backlight_on()
    
    # í™”ë©´ ì´ˆê¸°í™” (ê²€ì€ìƒ‰ìœ¼ë¡œ í´ë¦¬ì–´)
    clear_image = Image.new('RGB', (240, 240), (0, 0, 0))
    display_image(clear_image)
    print("í™”ë©´ í´ë¦¬ì–´ ì™„ë£Œ")

    # mpv ì´ˆê¸°í™”
    if not ensure_mpv_running():
        print("mpvë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ì–´ ì¢…ë£Œí•©ë‹ˆë‹¤.")
        GPIO.cleanup()
        release_lock()
        return

    # ì´ˆê¸° í™”ë©´ í‘œì‹œ
    display_radio_info(current_index, force_full=True)

    s1LastState = GPIO.input(S1)
    keyLastState = GPIO.input(KEY)

    last_rotation_time = 0.0
    needs_save = False
    last_change_time = 0.0
    pending_play = False
    last_station_change_time = 0.0
    last_input_time = 0.0
    last_updated_index = -1

    print("=" * 50)
    print("ğŸ“» ë¼ë””ì˜¤ ì‹œì‘! (ë¶€ë¶„ ë Œë”ë§ ìµœì í™”)")
    print("=" * 50)
    print("íšŒì „: ë°©ì†¡êµ­ ì„ íƒ")
    print("ë²„íŠ¼: ì¬ìƒ/ì •ì§€")
    print("Ctrl+C: ì¢…ë£Œ")
    print("=" * 50)

    try:
        while True:
            # ë¡œí„°ë¦¬ ì²˜ë¦¬ - ì¸ë±ìŠ¤ë§Œ ë³€ê²½
            s1State = GPIO.input(S1)
            s2State = GPIO.input(S2)

            # S1ì˜ falling edgeë§Œ ê°ì§€ (HIGH â†’ LOW)
            if s1State == 0 and s1LastState == 1:
                now = time.time()
                if now - last_rotation_time > ROTATION_DEBOUNCE_SEC:
                    # S2 ìƒíƒœë¡œ ë°©í–¥ ê²°ì •
                    if s2State == 1:
                        current_index = (current_index - 1) % len(radio_stations)
                    else:
                        current_index = (current_index + 1) % len(radio_stations)

                    print(f"â†’ {radio_stations[current_index]['name']}")

                    # íƒ€ì´ë¨¸ë§Œ ì—…ë°ì´íŠ¸
                    last_input_time = now

                    needs_save = True
                    last_change_time = now

                    if is_playing:
                        pending_play = True
                        last_station_change_time = now

                    last_rotation_time = now

            s1LastState = s1State

            # ë²„íŠ¼ ì²˜ë¦¬
            keyState = GPIO.input(KEY)
            if keyState == 0 and keyLastState == 1:
                if is_playing:
                    stop_playback()
                else:
                    play_station(current_index)

                display_radio_info(current_index)
                last_updated_index = current_index

                now = time.time()
                needs_save = True
                last_change_time = now
                time.sleep(0.3)

            keyLastState = keyState

            # ì…ë ¥ ë©ˆì¶˜ í›„ í™”ë©´ ì—…ë°ì´íŠ¸ (ì¸ë±ìŠ¤ ë°”ë€Œì—ˆì„ ë•Œë§Œ)
            if last_input_time > 0 and current_index != last_updated_index:
                if (time.time() - last_input_time) >= DISPLAY_UPDATE_DELAY:
                    display_radio_info(current_index)
                    last_updated_index = current_index

            # ë¡œí„°ë¦¬ ë©ˆì¶˜ í›„ ì¬ìƒ ì „í™˜
            if pending_play and (time.time() - last_station_change_time) >= PLAY_SWITCH_DELAY_SEC:
                play_station(current_index)
                pending_play = False

            # ì €ì¥
            if needs_save and (time.time() - last_change_time) >= SAVE_DELAY_SEC:
                save_last_station(current_index)
                needs_save = False

            time.sleep(0.001)

    except KeyboardInterrupt:
        print("\n\ní”„ë¡œê·¸ë¨ ì¢…ë£Œ")
        if needs_save:
            save_last_station(current_index)

        try:
            stop_playback()
        except Exception:
            pass

    finally:
        try:
            if player_process:
                player_process.terminate()
                player_process.wait(timeout=2)
        except Exception:
            pass

        if player_process:
            try:
                if os.path.exists(MPV_SOCK):
                    os.remove(MPV_SOCK)
            except Exception:
                pass

        if pwm_backlight:
            pwm_backlight.stop()

        GPIO.cleanup()
        if spi:
            spi.close()
        release_lock()

if __name__ == "__main__":
    main()
